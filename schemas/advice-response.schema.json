{
  "$schema": "https://json-schema.org/draft/2020-12/schema",
  "$id": "advice-response.schema.json",
  "title": "AdviceResponse",
  "description": "Transient response structure for getPortfolioAdvice() and getTaxStrategyAdvice(). Not persisted as NDJSON records.",
  "oneOf": [
    { "$ref": "#/$defs/portfolioAdviceResponse" },
    { "$ref": "#/$defs/taxStrategyAdviceResponse" }
  ],
  "$defs": {
    "recommendation": {
      "type": "object",
      "required": ["title", "rationale", "expectedImpact", "tradeoffs", "source"],
      "properties": {
        "title": { "type": "string", "maxLength": 500 },
        "rationale": { "type": "string", "maxLength": 2000 },
        "expectedImpact": { "type": "string", "maxLength": 1000 },
        "tradeoffs": { "type": "array", "items": { "type": "string", "maxLength": 500 }, "maxItems": 10 },
        "source": { "type": "string", "enum": ["llm", "fallback"] }
      },
      "additionalProperties": false
    },
    "portfolioAdviceResponse": {
      "type": "object",
      "required": ["recommendations", "withdrawalStrategyAdvice", "riskFlags", "assumptionSensitivity", "disclaimer"],
      "properties": {
        "recommendations": { "type": "array", "items": { "$ref": "#/$defs/recommendation" }, "maxItems": 25 },
        "withdrawalStrategyAdvice": {
          "type": "array",
          "maxItems": 25,
          "items": {
            "type": "object",
            "required": ["title", "rationale"],
            "properties": {
              "title": { "type": "string", "maxLength": 500 },
              "rationale": { "type": "string", "maxLength": 2000 }
            },
            "additionalProperties": false
          }
        },
        "riskFlags": { "type": "array", "items": { "type": "string", "maxLength": 500 }, "maxItems": 25 },
        "assumptionSensitivity": { "type": "array", "items": { "type": "string", "maxLength": 500 }, "maxItems": 25 },
        "disclaimer": { "type": "string", "maxLength": 2000 }
      },
      "additionalProperties": false
    },
    "taxStrategyAdviceResponse": {
      "type": "object",
      "required": ["recommendations", "taxOptimizationOpportunities", "riskFlags", "disclaimer"],
      "properties": {
        "recommendations": { "type": "array", "items": { "$ref": "#/$defs/recommendation" }, "maxItems": 25 },
        "taxOptimizationOpportunities": {
          "type": "array",
          "maxItems": 25,
          "items": {
            "type": "object",
            "required": ["title", "rationale"],
            "properties": {
              "title": { "type": "string", "maxLength": 500 },
              "rationale": { "type": "string", "maxLength": 2000 }
            },
            "additionalProperties": false
          }
        },
        "riskFlags": { "type": "array", "items": { "type": "string", "maxLength": 500 }, "maxItems": 25 },
        "disclaimer": { "type": "string", "maxLength": 2000 }
      },
      "additionalProperties": false
    }
  }
}
